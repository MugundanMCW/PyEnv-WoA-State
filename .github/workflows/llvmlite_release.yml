name: llvmlite release

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA or version identifier used in the build artifacts'
        required: true
      run_id:
        description: 'The run ID of the llvmlite_win-arm64_wheel_builder workflow'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download artifacts
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: llvmlite_win-arm64_wheel_builder.yml
          run_id: ${{ github.event.inputs.run_id }}
          path: artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded artifacts
        run: |
          echo "Downloaded wheel files:"
          find artifacts -type f -name "*.whl" | sort

      - name: Extract version information and create releases
        run: |
          set -euo pipefail

          for WHEEL_DIR in artifacts/llvmlite-${{ github.event.inputs.commit_sha }}-*; do
            if [ ! -d "$WHEEL_DIR" ]; then
              echo "No matching directories found for commit_sha=${{ github.event.inputs.commit_sha }}"
              continue
            fi

            DIR_NAME=$(basename "$WHEEL_DIR")
            echo "Processing directory: $DIR_NAME"

            # Expected directory format:
            # llvmlite-COMMIT_SHA-PLATFORM-PY_VERSION
            IFS='-' read -ra PARTS <<< "$DIR_NAME"

            PLATFORM="${PARTS[2]}"
            PY_VERSION="${PARTS[3]}"

            WHEEL_FILE=$(find "$WHEEL_DIR" -name "*.whl" | head -n 1)
            if [ -z "$WHEEL_FILE" ]; then
              echo "No wheel found in $WHEEL_DIR"
              continue
            fi

            WHEEL_BASENAME=$(basename "$WHEEL_FILE")

            PKG_VERSION=$(echo "$WHEEL_BASENAME" | sed -E 's/llvmlite-([0-9]+\.[0-9]+\.[0-9]+).*/\1/')

            if [ -z "$PKG_VERSION" ]; then
              echo "Failed to extract version from $WHEEL_BASENAME"
              continue
            fi

            RELEASE_TAG="llvmlite-${PKG_VERSION}-py${PY_VERSION}-${PLATFORM}"
            RELEASE_NAME="llvmlite ${PKG_VERSION} for Python ${PY_VERSION} (${PLATFORM})"

            echo "Creating release:"
            echo "  Tag:  $RELEASE_TAG"
            echo "  Name: $RELEASE_NAME"

            gh release create "$RELEASE_TAG" \
              --title "$RELEASE_NAME" \
              --notes "llvmlite Windows ARM64 wheel built from commit ${{ github.event.inputs.commit_sha }}" \
              --target "${{ github.ref_name }}" \
              --prerelease \
              "$WHEEL_FILE" || echo "Release $RELEASE_TAG already exists, skipping"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## llvmlite Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Created GitHub releases for the following wheels:" >> $GITHUB_STEP_SUMMARY
          find artifacts -type f -name "*.whl" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
